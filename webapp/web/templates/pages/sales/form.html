{{define "pages/sales/form"}}
<style>
        .product-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .product-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.1);
        }
        .product-card.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .expiry-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        .expiry-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .cart-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .quantity-input {
            width: 60px;
            text-align: center;
        }
        .price-input {
            width: 100px;
        }
        .discount-input {
            width: 80px;
        }
        .customer-info {
            background-color: #e7f3ff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .membership-benefits {
            background-color: #d4edda;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
</style>

<div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>{{.Title}}</h2>
                    <a href="/sales" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                </div>

                <form id="salesForm" method="POST" action="/sales">
                    <div class="row">
                        <!-- Left Column - Product Selection -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Chọn sản phẩm</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Customer Selection -->
                                    <div class="customer-info">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="customer_id" class="form-label">Khách hàng</label>
                                                <select class="form-select" id="customer_id" name="customer_id" onchange="updateCustomerInfo()">
                                                    <option value="">Khách hàng lẻ</option>
                                                    {{range .Customers}}
                                                    <option value="{{.CustomerID}}" 
                                                            data-phone="{{if .Phone}}{{.Phone}}{{end}}" 
                                                            data-membership="{{.MembershipLevelID}}"
                                                            data-points="{{.LoyaltyPoints}}">
                                                        {{if .FullName}}{{.FullName}}{{else}}Khách hàng {{.CustomerID}}{{end}}{{if .Phone}} ({{.Phone}}){{end}}
                                                    </option>
                                                    {{end}}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="employee_id" class="form-label">Nhân viên bán hàng *</label>
                                                <select class="form-select" id="employee_id" name="employee_id" required>
                                                    <option value="">Chọn nhân viên</option>
                                                    {{range .Employees}}
                                                    <option value="{{.EmployeeID}}">{{.FullName}}</option>
                                                    {{end}}
                                                </select>
                                            </div>
                                        </div>
                                        <div id="customerDetails" class="membership-benefits" style="display: none;">
                                            <small id="customerInfo"></small>
                                        </div>
                                    </div>

                                    <!-- Product Search -->
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="productSearch" placeholder="Tìm kiếm sản phẩm..." onkeyup="filterProducts()">
                                    </div>

                                    <!-- Product List -->
                                    <div id="productList" style="max-height: 400px; overflow-y: auto;">
                                        {{range .Products}}
                                        <div class="product-card" data-product-id="{{.ProductID}}" onclick="selectProduct(this)">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <strong>{{.ProductName}}</strong>
                                                    <br>
                                                    <small class="text-muted">{{.ProductCode}} - {{.CategoryName}}</small>
                                                    <br>
                                                    <small class="text-muted">Quầy: {{.ShelfName}}</small>
                                                    {{if .ExpiryDate}}
                                                    <br>
                                                    <small class="text-muted">HSD: {{.ExpiryDate.Format "02/01/2006"}}</small>
                                                    {{end}}
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <div class="fw-bold">{{.SellingPrice | formatCurrency}}</div>
                                                    {{if .DiscountPrice}}
                                                    <div class="text-danger">{{.DiscountPrice | formatCurrency}}</div>
                                                    {{end}}
                                                    <small class="text-muted">Còn: {{.ShelfQuantity}}</small>
                                                </div>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Cart -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Giỏ hàng</h5>
                                </div>
                                <div class="card-body">
                                    <div id="cartItems">
                                        <p class="text-muted text-center">Chưa có sản phẩm nào</p>
                                    </div>

                                    <!-- Payment Info -->
                                    <div class="mt-4">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="payment_method" class="form-label">Phương thức thanh toán</label>
                                                <select class="form-select" id="payment_method" name="payment_method">
                                                    <option value="CASH">Tiền mặt</option>
                                                    <option value="CARD">Thẻ</option>
                                                    <option value="TRANSFER">Chuyển khoản</option>
                                                    <option value="VOUCHER">Voucher</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="points_used" class="form-label">Điểm sử dụng</label>
                                                <input type="number" class="form-control" id="points_used" name="points_used" min="0" value="0" onchange="updateTotals()">
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label for="notes" class="form-label">Ghi chú</label>
                                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                                        </div>
                                    </div>

                                    <!-- Totals -->
                                    <div class="mt-4 p-3 bg-light rounded">
                                        <div class="d-flex justify-content-between">
                                            <span>Tạm tính:</span>
                                            <span id="subtotal">0 VND</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Giảm giá:</span>
                                            <span id="discountAmount" class="text-danger">0 VND</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Thuế VAT (10%):</span>
                                            <span id="taxAmount">0 VND</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Điểm sử dụng:</span>
                                            <span id="pointsUsed" class="text-info">0 điểm</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <strong>TỔNG CỘNG:</strong>
                                            <strong id="totalAmount" class="text-primary">0 VND</strong>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <span class="text-success">Điểm tích lũy:</span>
                                            <span id="pointsEarned" class="text-success">0 điểm</span>
                                        </div>
                                    </div>

                                    <!-- Submit Button -->
                                    <div class="mt-3">
                                        <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>
                                            <i class="fas fa-shopping-cart"></i> Tạo hóa đơn
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden inputs for form submission -->
                    <input type="hidden" id="product_ids" name="product_ids">
                    <input type="hidden" id="quantities" name="quantities">
                    <input type="hidden" id="unit_prices" name="unit_prices">
                    <input type="hidden" id="discount_percentages" name="discount_percentages">
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = [];
        let membershipLevels = {{.MembershipLevels | json}};

        function selectProduct(element) {
            const productId = element.dataset.productId;
            const productName = element.querySelector('strong').textContent;
            const productCode = element.querySelector('.text-muted').textContent.split(' - ')[0];
            const categoryName = element.querySelector('.text-muted').textContent.split(' - ')[1];
            const shelfName = element.querySelectorAll('.text-muted')[1].textContent.replace('Quầy: ', '');
            const sellingPrice = parseFloat(element.querySelector('.fw-bold').textContent.replace(/[^\d]/g, ''));
            const discountPrice = element.querySelector('.text-danger') ? parseFloat(element.querySelector('.text-danger').textContent.replace(/[^\d]/g, '')) : null;
            // Find the element containing "Còn:" text
            const quantityElement = Array.from(element.querySelectorAll('.text-muted')).find(el => el.textContent.includes('Còn:'));
            const shelfQuantity = quantityElement ? parseInt(quantityElement.textContent.replace('Còn: ', '')) : 0;
            
            console.log(`Debug selectProduct: quantityElement=`, quantityElement, `shelfQuantity=${shelfQuantity}`);

            // Check if product already in cart
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity < shelfQuantity) {
                    existingItem.quantity++;
                    updateCartDisplay();
                } else {
                    alert('Không đủ hàng trong kho!');
                }
            } else {
                cart.push({
                    productId: productId,
                    productName: productName,
                    productCode: productCode,
                    categoryName: categoryName,
                    shelfName: shelfName,
                    quantity: 1,
                    unitPrice: discountPrice || sellingPrice,
                    discountPercentage: discountPrice ? ((sellingPrice - discountPrice) / sellingPrice * 100) : 0,
                    maxQuantity: shelfQuantity
                });
                updateCartDisplay();
            }
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-muted text-center">Chưa có sản phẩm nào</p>';
                document.getElementById('submitBtn').disabled = true;
                return;
            }

            let html = '';
            cart.forEach((item, index) => {
                html += `
                    <div class="cart-item">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>${item.productName}</strong>
                                <br>
                                <small class="text-muted">${item.productCode} - ${item.categoryName}</small>
                                <br>
                                <small class="text-muted">Quầy: ${item.shelfName}</small>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-4">
                                        <label class="form-label">SL:</label>
                                        <input type="number" class="form-control quantity-input" 
                                               value="${item.quantity}" min="1" max="${item.maxQuantity}"
                                               onchange="updateQuantity(${index}, this.value)">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Giá:</label>
                                        <input type="number" class="form-control price-input" 
                                               value="${item.unitPrice}" step="0.01"
                                               onchange="updatePrice(${index}, this.value)">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Giảm %:</label>
                                        <input type="number" class="form-control discount-input" 
                                               value="${item.discountPercentage.toFixed(1)}" min="0" max="100" step="0.1"
                                               onchange="updateDiscount(${index}, this.value)">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="fw-bold">${(item.quantity * item.unitPrice * (1 - item.discountPercentage/100)).toLocaleString()} VND</span>
                                    <button type="button" class="btn btn-sm btn-outline-danger float-end" onclick="removeItem(${index})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            cartContainer.innerHTML = html;
            document.getElementById('submitBtn').disabled = false;
            updateTotals();
        }

        function updateQuantity(index, quantity) {
            quantity = parseInt(quantity);
            const maxQuantity = cart[index].maxQuantity;
            
            console.log(`Debug: quantity=${quantity}, maxQuantity=${maxQuantity}, cart item:`, cart[index]);
            
            if (quantity > 0 && quantity <= maxQuantity) {
                cart[index].quantity = quantity;
                updateCartDisplay();
            } else {
                alert(`Số lượng không hợp lệ! Số lượng phải từ 1 đến ${maxQuantity}`);
                updateCartDisplay();
            }
        }

        function updatePrice(index, price) {
            price = parseFloat(price);
            if (price > 0) {
                cart[index].unitPrice = price;
                updateCartDisplay();
            }
        }

        function updateDiscount(index, discount) {
            discount = parseFloat(discount);
            if (discount >= 0 && discount <= 100) {
                cart[index].discountPercentage = discount;
                updateCartDisplay();
            }
        }

        function removeItem(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }

        function updateCustomerInfo() {
            const customerSelect = document.getElementById('customer_id');
            const customerDetails = document.getElementById('customerDetails');
            const customerInfo = document.getElementById('customerInfo');
            
            if (customerSelect.value) {
                const option = customerSelect.options[customerSelect.selectedIndex];
                const membershipId = option.dataset.membership;
                const points = parseInt(option.dataset.points);
                
                const membership = membershipLevels.find(ml => ml.level_id == membershipId);
                if (membership) {
                    customerInfo.innerHTML = `
                        <strong>Thành viên:</strong> ${membership.level_name}<br>
                        <strong>Điểm hiện tại:</strong> ${points} điểm<br>
                        <strong>Giảm giá:</strong> ${membership.discount_percentage}%<br>
                        <strong>Tích điểm:</strong> ${membership.points_multiplier} điểm/1000 VND
                    `;
                    customerDetails.style.display = 'block';
                }
            } else {
                customerDetails.style.display = 'none';
            }
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            
            cart.forEach(item => {
                const itemSubtotal = item.quantity * item.unitPrice;
                const itemDiscount = itemSubtotal * (item.discountPercentage / 100);
                subtotal += itemSubtotal;
                totalDiscount += itemDiscount;
            });

            const pointsUsed = parseInt(document.getElementById('points_used').value) || 0;
            const pointsDiscount = pointsUsed * 1000; // 1 điểm = 1000 VND
            
            const netSubtotal = subtotal - totalDiscount - pointsDiscount;
            const taxAmount = netSubtotal * 0.1; // 10% VAT
            const totalAmount = netSubtotal + taxAmount;

            // Calculate points earned
            const customerSelect = document.getElementById('customer_id');
            let pointsEarned = 0;
            if (customerSelect.value) {
                const option = customerSelect.options[customerSelect.selectedIndex];
                const membershipId = option.dataset.membership;
                const membership = membershipLevels.find(ml => ml.level_id == membershipId);
                if (membership) {
                    pointsEarned = Math.floor(totalAmount * membership.points_multiplier / 1000);
                }
            }

            document.getElementById('subtotal').textContent = subtotal.toLocaleString() + ' VND';
            document.getElementById('discountAmount').textContent = totalDiscount.toLocaleString() + ' VND';
            document.getElementById('taxAmount').textContent = taxAmount.toLocaleString() + ' VND';
            document.getElementById('pointsUsed').textContent = pointsUsed + ' điểm';
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' VND';
            document.getElementById('pointsEarned').textContent = pointsEarned + ' điểm';
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const productName = card.querySelector('strong').textContent.toLowerCase();
                const productCode = card.querySelector('.text-muted').textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || productCode.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Form submission
        document.getElementById('salesForm').addEventListener('submit', function(e) {
            if (cart.length === 0) {
                e.preventDefault();
                alert('Vui lòng chọn ít nhất một sản phẩm!');
                return;
            }

            // Prepare hidden inputs
            document.getElementById('product_ids').value = cart.map(item => item.productId).join(',');
            document.getElementById('quantities').value = cart.map(item => item.quantity).join(',');
            document.getElementById('unit_prices').value = cart.map(item => item.unitPrice).join(',');
            document.getElementById('discount_percentages').value = cart.map(item => item.discountPercentage).join(',');
        });
    </script>
</div>
{{end}}
