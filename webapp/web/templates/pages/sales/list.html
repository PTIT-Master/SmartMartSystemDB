{{define "pages/sales/list"}}
<style>
    .invoice-card {
        transition: all 0.3s;
        border: 1px solid #e0e0e0;
    }
    .invoice-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .status-badge {
        font-size: 0.8rem;
    }
    .filter-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .pagination-info {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .payment-method {
        font-size: 0.85rem;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-receipt text-primary"></i> {{.Title}}</h2>
                    <a href="/sales/new" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Tạo hóa đơn mới
                    </a>
                </div>

                <!-- Filters -->
                <div class="filter-section">
                    <form method="GET" action="/sales">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="search" class="form-label">Tìm kiếm</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       value="{{.Filters.Search}}" placeholder="Số HĐ, tên KH, NV...">
                            </div>
                            <div class="col-md-2">
                                <label for="customer_id" class="form-label">Khách hàng</label>
                                <select class="form-select" id="customer_id" name="customer_id">
                                    <option value="">Tất cả</option>
                                    {{range .Customers}}
                                    <option value="{{.CustomerID}}" {{if eq (printf "%d" .CustomerID) $.Filters.CustomerID}}selected{{end}}>
                                        {{if .FullName}}{{.FullName}}{{else}}Khách hàng {{.CustomerID}}{{end}}
                                    </option>
                                    {{end}}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="employee_id" class="form-label">Nhân viên</label>
                                <select class="form-select" id="employee_id" name="employee_id">
                                    <option value="">Tất cả</option>
                                    {{range .Employees}}
                                    <option value="{{.EmployeeID}}" {{if eq (printf "%d" .EmployeeID) $.Filters.EmployeeID}}selected{{end}}>
                                        {{.FullName}}
                                    </option>
                                    {{end}}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="date_from" class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" id="date_from" name="date_from" 
                                       value="{{.Filters.DateFrom}}">
                            </div>
                            <div class="col-md-2">
                                <label for="date_to" class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" id="date_to" name="date_to" 
                                       value="{{.Filters.DateTo}}">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <a href="/sales" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Pagination Info -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="pagination-info">
                        <i class="fas fa-info-circle"></i>
                        Hiển thị {{.InvoiceCount}} / {{.Pagination.TotalCount}} hóa đơn
                        {{if gt .Pagination.TotalPages 1}}
                        (Trang {{.Pagination.CurrentPage}}/{{.Pagination.TotalPages}})
                        {{end}}
                    </div>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" onchange="changeLimit(this.value)">
                            <option value="20" {{if eq .Pagination.Limit 20}}selected{{end}}>20/trang</option>
                            <option value="50" {{if eq .Pagination.Limit 50}}selected{{end}}>50/trang</option>
                            <option value="100" {{if eq .Pagination.Limit 100}}selected{{end}}>100/trang</option>
                        </select>
                    </div>
                </div>

                <!-- Invoices List -->
                {{if .Invoices}}
                <div class="row">
                    {{range .Invoices}}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card invoice-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                <strong>{{.InvoiceNo}}</strong>
                                <span class="badge bg-light text-dark status-badge">
                                    <i class="fas fa-box"></i> {{.ItemCount}} sản phẩm
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-calendar"></i> Ngày:</small>
                                    <div class="fw-bold">{{.InvoiceDate | formatDate}}</div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-user"></i> Khách hàng:</small>
                                    <div>
                                        {{if .CustomerName}}
                                        <span class="fw-bold">{{.CustomerName}}</span>
                                        {{if .CustomerPhone}}<br><small class="text-muted">{{.CustomerPhone}}</small>{{end}}
                                        {{else}}
                                        <em class="text-muted">Khách hàng lẻ</em>
                                        {{end}}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-user-tie"></i> Nhân viên:</small>
                                    <div class="fw-bold">{{.EmployeeName}}</div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted"><i class="fas fa-credit-card"></i> Thanh toán:</small>
                                    <div class="payment-method">
                                        {{if .PaymentMethod}}
                                            {{if eq (printf "%s" .PaymentMethod) "CASH"}}<i class="fas fa-money-bill-wave text-success"></i> Tiền mặt{{end}}
                                            {{if eq (printf "%s" .PaymentMethod) "CARD"}}<i class="fas fa-credit-card text-info"></i> Thẻ{{end}}
                                            {{if eq (printf "%s" .PaymentMethod) "TRANSFER"}}<i class="fas fa-university text-primary"></i> Chuyển khoản{{end}}
                                            {{if eq (printf "%s" .PaymentMethod) "VOUCHER"}}<i class="fas fa-ticket-alt text-warning"></i> Voucher{{end}}
                                            {{if and (ne (printf "%s" .PaymentMethod) "CASH") (ne (printf "%s" .PaymentMethod) "CARD") (ne (printf "%s" .PaymentMethod) "TRANSFER") (ne (printf "%s" .PaymentMethod) "VOUCHER")}}<i class="fas fa-question-circle text-muted"></i> {{.PaymentMethod}}{{end}}
                                        {{else}}
                                            <i class="fas fa-question-circle text-muted"></i> Chưa xác định
                                        {{end}}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted"><i class="fas fa-dollar-sign"></i> Tổng tiền:</small>
                                    <div class="fw-bold text-primary fs-5">{{.TotalAmount | formatCurrency}}</div>
                                </div>
                                
                                {{if gt .PointsEarned 0}}
                                <div class="mb-2">
                                    <small class="text-success"><i class="fas fa-plus-circle"></i> Điểm tích lũy: +{{.PointsEarned}}</small>
                                </div>
                                {{end}}
                                
                                {{if gt .PointsUsed 0}}
                                <div class="mb-2">
                                    <small class="text-info"><i class="fas fa-minus-circle"></i> Điểm sử dụng: -{{.PointsUsed}}</small>
                                </div>
                                {{end}}

                                {{if gt .DiscountAmount 0.0}}
                                <div class="mb-2">
                                    <small class="text-warning"><i class="fas fa-percentage"></i> Giảm giá: {{.DiscountAmount | formatCurrency}}</small>
                                </div>
                                {{end}}
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between">
                                    <a href="/sales/{{.InvoiceID}}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Xem
                                    </a>
                                    <a href="/sales/invoice/{{.InvoiceID}}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-print"></i> In
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>

                <!-- Pagination -->
                {{if gt .Pagination.TotalPages 1}}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {{if gt .Pagination.CurrentPage 1}}
                        <li class="page-item">
                            <a class="page-link" href="?page={{sub .Pagination.CurrentPage 1}}&limit={{.Pagination.Limit}}&search={{.Filters.Search}}&customer_id={{.Filters.CustomerID}}&employee_id={{.Filters.EmployeeID}}&date_from={{.Filters.DateFrom}}&date_to={{.Filters.DateTo}}">
                                <i class="fas fa-chevron-left"></i> Trước
                            </a>
                        </li>
                        {{end}}
                        
                        <li class="page-item active">
                            <span class="page-link">
                                Trang {{.Pagination.CurrentPage}} / {{.Pagination.TotalPages}}
                            </span>
                        </li>
                        
                        {{if lt .Pagination.CurrentPage .Pagination.TotalPages}}
                        <li class="page-item">
                            <a class="page-link" href="?page={{add .Pagination.CurrentPage 1}}&limit={{.Pagination.Limit}}&search={{.Filters.Search}}&customer_id={{.Filters.CustomerID}}&employee_id={{.Filters.EmployeeID}}&date_from={{.Filters.DateFrom}}&date_to={{.Filters.DateTo}}">
                                Sau <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {{end}}
                    </ul>
                </nav>
                {{end}}

                {{else}}
                <!-- No Invoices -->
                <div class="alert alert-warning text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                    <h4>Không có hóa đơn nào</h4>
                    <p class="mb-4">Chưa có hóa đơn bán hàng nào được tạo hoặc không tìm thấy hóa đơn phù hợp với bộ lọc.</p>
                    <div>
                        <a href="/sales/new" class="btn btn-primary me-2">
                            <i class="fas fa-plus"></i> Tạo hóa đơn đầu tiên
                        </a>
                        <a href="/sales" class="btn btn-outline-secondary">
                            <i class="fas fa-refresh"></i> Xóa bộ lọc
                        </a>
                    </div>
                </div>
                {{end}}

                <!-- Debug Info (only show if there are SQL queries) -->
                {{if .SQLQueries}}
                <div class="mt-4">
                    <details class="alert alert-info">
                        <summary><i class="fas fa-database"></i> Debug Info ({{.TotalSQLQueries}} queries)</summary>
                        <pre class="mt-2 mb-0"><code>{{.SQLQueries}}</code></pre>
                    </details>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function changeLimit(limit) {
            const url = new URL(window.location);
            url.searchParams.set('limit', limit);
            url.searchParams.set('page', '1');
            window.location.href = url.toString();
        }

        // Auto-submit form on filter change
        document.addEventListener('DOMContentLoaded', function() {
            const filterInputs = document.querySelectorAll('#customer_id, #employee_id, #date_from, #date_to');
            filterInputs.forEach(input => {
                input.addEventListener('change', function() {
                    this.form.submit();
                });
            });
        });
    </script>
        </div>
    </div>
</div>
{{end}}