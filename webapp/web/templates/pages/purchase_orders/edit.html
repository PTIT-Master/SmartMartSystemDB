<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}
.modal.show {
    display: flex !important;
    align-items: center;
    justify-content: center;
}
.modal-dialog {
    background: white;
    border-radius: 0.375rem;
    max-width: 90%;
    width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}
.modal-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-body {
    padding: 1rem;
}
.close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-edit mr-2"></i>
                        {{.Title}} - {{.Order.OrderNo}}
                    </h3>
                    <div class="card-tools">
                        <a href="/purchase-orders/{{.Order.OrderID}}" class="btn btn-sm btn-secondary">
                            <i class="fas fa-arrow-left mr-1"></i>
                            Quay lại
                        </a>
                    </div>
                </div>

                <form method="POST" action="/purchase-orders/{{.Order.OrderID}}" id="purchaseOrderForm">
                    <input type="hidden" name="_method" value="PUT">
                    
                    <div class="card-body">
                        <div class="row">
                            <!-- Order Information -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="supplier_id">Nhà cung cấp <span class="text-danger">*</span></label>
                                    <select class="form-control" id="supplier_id" name="supplier_id" required>
                                        <option value="">Chọn nhà cung cấp</option>
                                        {{range .Suppliers}}
                                        <option value="{{.SupplierID}}" {{if eq .SupplierID $.Order.SupplierID}}selected{{end}}>
                                            {{.SupplierName}}
                                        </option>
                                        {{end}}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="employee_id">Nhân viên đặt hàng <span class="text-danger">*</span></label>
                                    <select class="form-control" id="employee_id" name="employee_id" required>
                                        <option value="">Chọn nhân viên</option>
                                        {{range .Employees}}
                                        <option value="{{.EmployeeID}}" {{if eq .EmployeeID $.Order.EmployeeID}}selected{{end}}>
                                            {{.FullName}} ({{.EmployeeCode}})
                                        </option>
                                        {{end}}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="status">Trạng thái</label>
                                    <select class="form-control" id="status" name="status">
                                        <option value="PENDING" {{if eq .Order.Status "PENDING"}}selected{{end}}>Chờ duyệt</option>
                                        <option value="APPROVED" {{if eq .Order.Status "APPROVED"}}selected{{end}}>Đã duyệt</option>
                                        <option value="RECEIVED" {{if eq .Order.Status "RECEIVED"}}selected{{end}}>Đã nhận</option>
                                        <option value="CANCELLED" {{if eq .Order.Status "CANCELLED"}}selected{{end}}>Đã hủy</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="delivery_date">Ngày giao hàng dự kiến</label>
                                    <input type="date" class="form-control" id="delivery_date" name="delivery_date" 
                                           value="{{if .Order.DeliveryDate}}{{.Order.DeliveryDate.Format "2006-01-02"}}{{end}}">
                                </div>

                                <div class="form-group">
                                    <label for="notes">Ghi chú</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Ghi chú về đơn đặt hàng...">{{if .Order.Notes}}{{.Order.Notes}}{{end}}</textarea>
                                </div>
                            </div>

                            <!-- Order Details -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Chi tiết đơn hàng</h5>
                                    <button type="button" class="btn btn-sm btn-primary" id="addProductBtn">
                                        <i class="fas fa-plus mr-1"></i>
                                        Thêm sản phẩm
                                    </button>
                                </div>

                                <div id="productDetails">
                                    <!-- Existing product rows -->
                                    <div id="emptyState" class="text-center text-muted py-4" style="display: none;">
                                        <i class="fas fa-box-open fa-2x mb-2"></i>
                                        <br>
                                        Chưa có sản phẩm nào trong đơn hàng
                                        <br>
                                        <small>Nhấn nút "Thêm sản phẩm" để bắt đầu</small>
                                    </div>
                                    {{range .Details}}
                                    <div class="product-row border rounded p-3 mb-2">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-2">
                                                    <label>Sản phẩm</label>
                                                    <input type="text" class="form-control" value="{{if .Product}}{{.Product.ProductName}}{{else}}N/A{{end}}" readonly>
                                                    <input type="hidden" name="product_id[]" value="{{.ProductID}}">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-2">
                                                    <label>Số lượng</label>
                                                    <input type="number" class="form-control" name="quantity[]" value="{{.Quantity}}" min="1" required>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-2">
                                                    <label>Đơn giá</label>
                                                    <input type="number" class="form-control" name="unit_price[]" value="{{.UnitPrice}}" min="0" step="0.01" required>
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                <div class="form-group mb-2">
                                                    <label>Đơn vị</label>
                                                    <input type="text" class="form-control" value="{{if .Product}}{{.Product.Unit}}{{else}}N/A{{end}}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                <div class="form-group mb-2">
                                                    <label>Thành tiền</label>
                                                    <input type="text" class="form-control subtotal" value="{{.Subtotal}}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <button type="button" class="btn btn-sm btn-danger removeProductBtn">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {{end}}
                                </div>

                                <div class="row mt-3">
                                    <div class="col-6">
                                        <strong>Tổng số lượng:</strong>
                                        <span id="totalQuantity">0</span>
                                    </div>
                                    <div class="col-6 text-right">
                                        <strong>Tổng tiền:</strong>
                                        <span id="totalAmount" class="text-success font-weight-bold">{{formatCurrency .Order.TotalAmount}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i>
                            Cập nhật đơn đặt hàng
                        </button>
                        <a href="/purchase-orders/{{.Order.OrderID}}" class="btn btn-secondary ml-2">
                            <i class="fas fa-times mr-1"></i>
                            Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="productTable">
                        <thead>
                            <tr>
                                <th>Mã SP</th>
                                <th>Tên sản phẩm</th>
                                <th>Đơn giá nhập</th>
                                <th>Đơn vị</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Products}}
                            <tr data-product-id="{{.ProductID}}" data-product-name="{{.ProductName}}" data-import-price="{{.ImportPrice}}" data-unit="{{.Unit}}">
                                <td>{{.ProductCode}}</td>
                                <td>{{.ProductName}}</td>
                                <td>{{formatCurrency .ImportPrice}}</td>
                                <td>{{.Unit}}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary selectProductBtn">
                                        Chọn
                                    </button>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let productCounter = 0;
    const products = {{json .Products}};

    // Initialize calculations
    calculateTotals();
    
    // Show empty state if no existing products
    const productRows = document.querySelectorAll('.product-row');
    if (productRows.length === 0) {
        showEmptyState();
    }

    // Add product button
    document.getElementById('addProductBtn').addEventListener('click', function() {
        const modal = document.getElementById('productModal');
        modal.style.display = 'block';
        modal.classList.add('show');
    });

    // Close modal when clicking X
    document.addEventListener('click', function(e) {
        if (e.target.closest('.close') || e.target.classList.contains('close')) {
            const modal = document.getElementById('productModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
    });

    // Product selection
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('selectProductBtn')) {
            const row = e.target.closest('tr');
            const productId = row.dataset.productId;
            const productName = row.dataset.productName;
            const importPrice = parseFloat(row.dataset.importPrice);
            const unit = row.dataset.unit;

            addProductRow(productId, productName, importPrice, unit);
            
            const modal = document.getElementById('productModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
    });

    // Remove product row
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('removeProductBtn')) {
            e.target.closest('.product-row').remove();
            calculateTotals();
            
            // Show empty state if no products left
            const productRows = document.querySelectorAll('.product-row');
            if (productRows.length === 0) {
                showEmptyState();
            }
        }
    });

    // Quantity and price changes
    document.addEventListener('input', function(e) {
        if (e.target.name === 'quantity[]' || e.target.name === 'unit_price[]') {
            calculateSubtotal(e.target.closest('.product-row'));
            calculateTotals();
        }
    });

    function addProductRow(productId = '', productName = '', importPrice = 0, unit = '') {
        productCounter++;
        const rowHtml = `
            <div class="product-row border rounded p-3 mb-2">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-2">
                            <label>Sản phẩm</label>
                            <input type="text" class="form-control" value="${productName}" readonly>
                            <input type="hidden" name="product_id[]" value="${productId}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-2">
                            <label>Số lượng</label>
                            <input type="number" class="form-control" name="quantity[]" value="1" min="1" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-2">
                            <label>Đơn giá</label>
                            <input type="number" class="form-control" name="unit_price[]" value="${importPrice}" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group mb-2">
                            <label>Đơn vị</label>
                            <input type="text" class="form-control" value="${unit}" readonly>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group mb-2">
                            <label>Thành tiền</label>
                            <input type="text" class="form-control subtotal" value="${importPrice}" readonly>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-sm btn-danger removeProductBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('productDetails').insertAdjacentHTML('beforeend', rowHtml);
        hideEmptyState();
        calculateTotals();
    }

    function showEmptyState() {
        document.getElementById('emptyState').style.display = 'block';
    }

    function hideEmptyState() {
        document.getElementById('emptyState').style.display = 'none';
    }

    function calculateSubtotal(row) {
        const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
        const unitPrice = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;
        const subtotal = quantity * unitPrice;
        row.querySelector('.subtotal').value = subtotal.toFixed(2);
    }

    function calculateTotals() {
        let totalQuantity = 0;
        let totalAmount = 0;

        document.querySelectorAll('.product-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
            const subtotal = parseFloat(row.querySelector('.subtotal').value) || 0;
            totalQuantity += quantity;
            totalAmount += subtotal;
        });

        document.getElementById('totalQuantity').textContent = totalQuantity;
        document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' VND';
    }

    // Form validation
    document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
        const productRows = document.querySelectorAll('.product-row');
        if (productRows.length === 0) {
            e.preventDefault();
            alert('Vui lòng thêm ít nhất một sản phẩm vào đơn hàng.');
            return;
        }
    });
});
</script>
